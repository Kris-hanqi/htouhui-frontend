stages:
  - build
  - deploy

variables:
  SERVICE_PORT: "9666"
  DOCKER_IMAGE_VERSION: "0.0.1-release"

cache:
  paths:
   - node_modules/

build_job:
  stage: build
  script:
    - rm -rf dist docker/dist
    - yarn
    - yarn run build
    - mv dist docker
    - cd docker
    - PUBLISH_VERSION=$(echo $CI_COMMIT_REF_NAME | cut -d'/' -f 2)
    - docker build --build-arg PUBLISH_VERSION=$PUBLISH_VERSION -t registry-internal.cn-beijing.aliyuncs.com/htouhui/nginx-hth-frontend:$DOCKER_IMAGE_VERSION .

deploy_job:
  stage: deploy
  only:
    - branches
  except:
    - master
  script:
    - PUBLISH_VERSION=$(echo $CI_COMMIT_REF_NAME | cut -d'/' -f 2)
    - docker stop nginx-hth-frontend-$CI_BUILD_REF_SLUG || true
    - docker rm -f nginx-hth-frontend-$CI_BUILD_REF_SLUG || true
    - docker run -d -p $SERVICE_PORT:80 --name nginx-hth-frontend-$CI_BUILD_REF_SLUG -t registry-internal.cn-beijing.aliyuncs.com/htouhui/nginx-hth-frontend:$DOCKER_IMAGE_VERSION

deploy_docker_image:
  stage: deploy
  only:
    - master
  environment:
    name: production
    url: http://loan.htouhui.com/
  when: manual
  script:
    - docker login --username=228044108@qq.com --password=cnFbU8VKtvn3daF registry-internal.cn-beijing.aliyuncs.com
    - docker tag registry-internal.cn-beijing.aliyuncs.com/htouhui/nginx-hth-frontend:$DOCKER_IMAGE_VERSION registry-internal.cn-beijing.aliyuncs.com/htouhui/nginx-hth-frontend:latest
    - docker push registry-internal.cn-beijing.aliyuncs.com/htouhui/nginx-hth-frontend:$DOCKER_IMAGE_VERSION
    - docker push registry-internal.cn-beijing.aliyuncs.com/htouhui/nginx-hth-frontend:latest
